<!DOCTYPE html>
<html lang="en">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
    <meta charset="UTF-8">
    <title>RunVis</title>
</head>
<body>
<label>
    <span style="font-size: 144%; ">
    Vivicittá 2018 - Félmaraton vizualizáció
        </span>
</label>
<div id="buttonDiv">
    <input type="range" min="0" max="12000" value="0" class="slider" id="timeRange">
    <button type="button" onclick="onStartButtonClick()">Start</button>
    <button type="button" onclick="onStopButtonClick()">Stop</button>
    <button type="button" onclick="onResetButtonClick()">Reset</button>
    <label>Idő:</label>
    <label id="time">00:00:00</label>
</div>

<div id="inputDiv">
    Rajtszám: <input id="runner_id" type="text" id="text-input" size="4">
    <button type="button" onclick="onSearchButtonClick()">Keres</button>
    <button type="button" onclick="onXButtonClick()">X</button>
    <label id="resultText"/>
</div>
<canvas id="run-canvas" class="plot"></canvas>
</body>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script>

    unit = Math.floor(screen.availHeight / 200) * 10;
    console.log(unit);

    margin = {top: 0.5 * unit, right: unit, bottom: 0, left: unit};
    width = 6 * unit;
    height = 18 * unit;


    started = false;
    time = 0;
    highlighted_id = -1;


    routeWidth = unit / 2;
    dotRadius = 1;

    console.log(screen.availHeight);

    var slider = document.getElementById("timeRange");
    slider.oninput = function () {
        time = +this.value;
        document.getElementById("time").innerHTML = seconds_to_hms(time);
        draw()
    };

    var canvas = d3.select('#run-canvas')
        .attr('width', width)
        .attr('height', height)
        .style("transform", "translate(" + (margin.left) +
            "px" + "," + (margin.top) + "px" + ")");
    var context = canvas.node().getContext('2d');

    var runners;

    d3.csv("vivicitta_2018.csv").then(function (data) {
        runners = data;

        draw();
        d3.interval(function () {
            if (started) {
                time += 12;

                slider.value = time;
                document.getElementById("time").innerHTML = seconds_to_hms(time);
                draw();
            }
        }, 20);
    });

    function drawRoute() {
        // Route
        context.beginPath();
        context.moveTo(3 * unit, 4 * unit);
        context.lineTo(3 * unit, 5 * unit);
        context.lineTo(4 * unit, 5 * unit);
        context.lineTo(4 * unit, 9 * unit);
        context.lineTo(unit, 9 * unit);
        context.lineTo(unit, 8 * unit);
        context.lineTo(2 * unit, 8 * unit);
        context.lineTo(2 * unit, 16 * unit);
        context.lineTo(unit, 16 * unit);
        context.lineTo(unit, 13 * unit);
        context.lineTo(4 * unit, 13 * unit);
        context.lineTo(4 * unit, 9 * unit);
        context.moveTo(4 * unit, 5 * unit);
        context.lineTo(4 * unit, 4 * unit);
        context.lineTo(5 * unit, 4 * unit);
        context.lineTo(5 * unit, 5 * unit);
        context.lineTo(4 * unit, 5 * unit);
        context.moveTo(3 * unit, 4 * unit);
        context.lineTo(3 * unit, 1.8 * unit);

        context.strokeStyle = "rgb(231,225,239)";
        context.lineWidth = routeWidth;
        context.stroke();
    }

    function drawDanube() {
        context.beginPath();
        context.moveTo(3 * unit, 0);
        context.lineTo(3 * unit, 0.5 * unit);
        context.lineTo(3.5 * unit, unit);
        context.lineTo(3.5 * unit, 5.5 * unit);
        context.lineTo(3 * unit, 6 * unit);
        context.moveTo(3 * unit, 0.5 * unit);
        context.lineTo(2.5 * unit, unit);
        context.lineTo(2.5 * unit, 5.5 * unit);
        context.lineTo(3 * unit, 6 * unit);
        context.lineTo(3 * unit, 17 * unit);

        context.strokeStyle = "rgb(127, 127, 255)";
        context.lineWidth = 10;
        context.stroke();
    }

    function drawDot(d, r) {
        let state = getState(d);
        let cx = runner_x(d, state);
        let cy = runner_y(d, state);

        context.beginPath();

        context.arc(cx, cy, r, 0, 2 * Math.PI);
        context.fill();
    }

    function drawLines() {
        // Start line
        context.font = routeWidth + "px Arial Black";
        context.fillStyle = "black";
        context.fillText("start", 0.8 * unit, 4.1 * unit);

        context.beginPath();
        context.moveTo(2.68 * unit, 4 * unit);
        context.lineTo(3.32 * unit, 4 * unit);

        // Finish line
        context.fillText("finish", 0.8 * unit, 1.9 * unit);

        context.moveTo(2.68 * unit, 1.8 * unit);
        context.lineTo(3.32 * unit, 1.8 * unit);


        // Sub results
        context.fillText("10k", 0.5 * unit, 17 * unit);
        context.moveTo(0.70 * unit, 16.3 * unit);
        context.lineTo(1.35 * unit, 15.65 * unit);

        context.fillText("13k", 3.5 * unit, 14 * unit);
        context.moveTo(3.65 * unit, 12.65 * unit);
        context.lineTo(4.3 * unit, 13.3 * unit);


        context.fillText("18k", 4.5 * unit, 3.5 * unit);
        context.moveTo(4.65 * unit, 4.35 * unit);
        context.lineTo(5.3 * unit, 3.7 * unit);

        context.strokeStyle = "black";
        context.lineWidth = 3;
        context.stroke();

        context.fillStyle = "rgb(127, 127, 255)";
        context.save();
        context.translate(3.3 * unit, 15 * unit);
        context.rotate(Math.PI / 2);
        context.fillText("Duna", 0, 0);

        context.restore();
    }

    function draw() {
        context.clearRect(0, 0, width, height);
        drawDanube();
        drawRoute();

        if (highlighted_id === -1) {
            context.fillStyle = 'rgb(230, 0, 126)';
            runners.forEach(function (d) {
                drawDot(d, dotRadius);
            });
        } else {
            context.fillStyle = 'rgb(201,148,199)';
            runners.forEach(function (d) {
                drawDot(d, dotRadius);
            });
            let highlighted = runners.find(runner => runner.running_id === highlighted_id);
            context.fillStyle = 'rgb(230, 0, 126)';
            drawDot(highlighted, 8 * dotRadius)
        }

        drawLines();
    }

    function getState(d) {
        let phase;
        let progress;
        let start_time = hms_to_seconds(d["gross_time"]) - hms_to_seconds(d["net_time"]);
        let net_time;

        if (time < hms_to_seconds(d["10km"])) {
            let net_ten_k = hms_to_seconds(d["10km"]) - start_time;
            phase = "10k";
            net_time = time - start_time;
            progress = net_time / net_ten_k;

        } else if (time < hms_to_seconds(d["17km"])) {
            let net_seventeen_k = hms_to_seconds(d["17km"]) - hms_to_seconds(d["10km"]);
            phase = "17k";
            net_time = time - hms_to_seconds(d["10km"]);
            progress = net_time / net_seventeen_k;
        } else {
            let net_twenty_one_k = hms_to_seconds(d["gross_time"]) - hms_to_seconds(d["17km"]);
            phase = "21k";
            net_time = time - hms_to_seconds(d["17km"]);
            progress = net_time / net_twenty_one_k;
        }

        return {phase: phase, progress: progress};
    }

    function onStartButtonClick() {
        started = true;
    }

    function onStopButtonClick() {
        started = false;
    }

    function onResetButtonClick() {
        time = 0;
        draw();
    }

    function onSearchButtonClick() {
        let search_id = document.getElementById('runner_id').value;
        let result = runners.find(runner => runner.running_id === search_id);
        console.log(result);
        if (typeof result !== 'undefined') {
            highlighted_id = result.running_id;
            document.getElementById("resultText").innerHTML = "";
        } else {
            document.getElementById("resultText").innerHTML = "Nincs találat!";
            highlighted_id = -1;
        }
        draw();
    }

    function onXButtonClick() {
        document.getElementById('runner_id').value = "";
        highlighted_id = -1;
        draw();
    }

    function getRandomOffset(running_id) {
        let scale = (routeWidth - dotRadius)
        let random = (31 * running_id + 127) % scale
        return random - scale / 2
    }

    function runner_x(d, state) {
        switch (state.phase) {
            case "10k":
                if (state.progress < 0.05) return 3 * unit + getRandomOffset(d.running_id);
                else if (state.progress < 0.1) {
                    let min = 3 * unit + getRandomOffset(d.running_id);
                    let max = 4 * unit + getRandomOffset(d.running_id);
                    return min + (max - min) * (state.progress - 0.05) * 20;
                }
                else if (state.progress < 0.3) return 4 * unit + getRandomOffset(d.running_id);
                else if (state.progress < 0.45) {
                    let min = 4 * unit + getRandomOffset(d.running_id);
                    let max = unit - getRandomOffset(d.running_id);
                    return min + (max - min) * (state.progress - 0.3) * 20 / 3;
                }
                else if (state.progress < 0.5) return unit - getRandomOffset(d.running_id);
                else if (state.progress < 0.55) {
                    let min = unit - getRandomOffset(d.running_id);
                    let max = 2 * unit + getRandomOffset(d.running_id);
                    return min + (max - min) * (state.progress - 0.5) * 20;
                }
                else if (state.progress < 0.95) return 2 * unit + getRandomOffset(d.running_id);
                else {
                    let min = 2 * unit + getRandomOffset(d.running_id);
                    let max = unit - getRandomOffset(d.running_id);
                    return min + (max - min) * (state.progress - 0.95) * 20;
                }
            case "17k":
                if (state.progress < 1.5 / 7) return unit - getRandomOffset(d.running_id);
                else if (state.progress < 3 / 7) {
                    let min = unit - getRandomOffset(d.running_id);
                    let max = 4 * unit - getRandomOffset(d.running_id);
                    return min + (max - min) * (state.progress - 1.5 / 7) * 7 / 1.5;
                }
                else return 4 * unit - getRandomOffset(d.running_id);
            case "21k":
                if (state.progress < 0.5 / 4.1) return 4 * unit - getRandomOffset(d.running_id);
                else if (state.progress < 1.0 / 4.1) {
                    let min = 4 * unit - getRandomOffset(d.running_id);
                    let max = 5 * unit + getRandomOffset(d.running_id);
                    return min + (max - min) * (state.progress - 0.5 / 4.1) * 4.1 / 0.5;
                }
                else if (state.progress < 1.5 / 4.1) return 5 * unit + getRandomOffset(d.running_id);
                else if (state.progress < 2.5 / 4.1) {
                    let min = 5 * unit + getRandomOffset(d.running_id);
                    let max = 3 * unit - getRandomOffset(d.running_id);
                    return min + (max - min) * (state.progress - 1.5 / 4.1) * 4.1;
                }
                else return 3 * unit - getRandomOffset(d.running_id);
        }
        // let random = (31 * i + 127) % 17
        // return random * 2 + 10
    }

    function runner_y(d, state) {
        switch (state.phase) {
            case "10k":
                if (state.progress < 0) {
                    let min = 4 * unit;
                    let max = 2 * unit;
                    return min + (max - min) * -state.progress;
                }
                else if (state.progress < 0.05) {
                    let min = 4 * unit;
                    let max = 5 * unit - getRandomOffset(d.running_id);
                    return min + (max - min) * state.progress * 20;
                }
                else if (state.progress < 0.1) return 5 * unit - getRandomOffset(d.running_id);
                else if (state.progress < 0.3) {
                    let min = 5 * unit - getRandomOffset(d.running_id);
                    let max = 9 * unit + getRandomOffset(d.running_id);
                    return min + (max - min) * (state.progress - 0.1) * 5;
                }
                else if (state.progress < 0.45) return 9 * unit + getRandomOffset(d.running_id);
                else if (state.progress < 0.5) {
                    let min = 9 * unit + getRandomOffset(d.running_id);
                    let max = 8 * unit - getRandomOffset(d.running_id);
                    return min + (max - min) * (state.progress - 0.45) * 20
                }
                else if (state.progress < 0.55) return 8 * unit - getRandomOffset(d.running_id);
                else if (state.progress < 0.95) {
                    let min = 8 * unit - getRandomOffset(d.running_id);
                    let max = 16 * unit + getRandomOffset(d.running_id);
                    return min + (max - min) * (state.progress - 0.55) * 5 / 2
                } else return 16 * unit + getRandomOffset(d.running_id);
            case "17k":
                if (state.progress < 1.5 / 7) {
                    let min = 16 * unit + getRandomOffset(d.running_id);
                    let max = 13 * unit - getRandomOffset(d.running_id);
                    return min + (max - min) * state.progress * 7 / 1.5;
                }
                else if (state.progress < 3 / 7) return 13 * unit - getRandomOffset(d.running_id);
                else {
                    let min = 13 * unit - getRandomOffset(d.running_id);
                    let max = 5 * unit;
                    return min + (max - min) * (state.progress - 3 / 7) * 7 / 4;
                }
            case "21k":
                if (state.progress < 0.5 / 4.1) {
                    let min = 5 * unit;
                    let max = 4 * unit - getRandomOffset(d.running_id);
                    return min + (max - min) * (state.progress) * 4.1 / 0.5;
                }
                else if (state.progress < 1.0 / 4.1) return 4 * unit - getRandomOffset(d.running_id);
                else if (state.progress < 1.5 / 4.1) {
                    let min = 4 * unit - getRandomOffset(d.running_id);
                    let max = 5 * unit + getRandomOffset(d.running_id);
                    return min + (max - min) * (state.progress - 1 / 4.1) * 4.1 / 0.5;
                }
                else if (state.progress < 2.5 / 4.1) return 5 * unit + getRandomOffset(d.running_id);
                else if (state.progress < 1) {
                    let min = 5 * unit + getRandomOffset(d.running_id);
                    let max = 1.8 * unit;
                    return min + (max - min) * (state.progress - 2.5 / 4.1) * 4.1 / 1.6;
                }
                else {
                    let min = 1.8 * unit;
                    let max = 1.3 * unit;
                    return min + (max - min) * (1 - 1 / state.progress);
                }

        }
    }

    function hms_to_seconds(hms) {
        let a = hms.split(':');
        return (+a[0]) * 60 * 60 + (+a[1]) * 60 + (+a[2]);
    }

    function seconds_to_hms(seconds) {
        return new Date(seconds * 1000).toISOString().substr(11, 8);
    }

</script>
</html>